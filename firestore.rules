rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check for rate limiting.
    // This approach requires a backend function (e.g., a scheduled Cloud Function) 
    // to periodically clean up old documents from the 'write_logs' subcollection 
    // to prevent it from growing indefinitely.
    function isRateLimited(userId) {
      // Limit to 100 writes per hour.
      return firestore.getAfter(
          /databases/$(database)/documents/users/$(userId)/write_logs/
      ).size() >= 100 &&
      firestore.getAfter(
          /databases/$(database)/documents/users/$(userId)/write_logs/
      ).timestamp > timestamp.now() - duration.time(1, 0, 0, 0);
    }

    // Users can only read and write their own data.
    match /users/{userId} {
      allow read, update, delete: if request.auth.uid == userId;
      // Creation is allowed if the user is authenticated and not rate-limited.
      allow create: if request.auth.uid == userId;

      // Rate limiting log. A document is created here on each write.
      match /write_logs/{logId} {
        allow create: if request.auth.uid == userId;
      }
    }
    
    // Data collections where documents are owned by users.
    match /{collection}/{docId} 
    where collection in ['leads', 'targets', 'actions'] {
      // Reads and writes are allowed if the user is the owner of the document.
      allow read, write: if request.auth.uid == get(/databases/$(database)/documents/$(collection)/$(docId)).data.userId;
      // Creation is allowed if the user is authenticated, the owner, and not rate-limited.
      allow create: if request.auth.uid == request.resource.data.userId && !isRateLimited(request.auth.uid);
    }

    // The 'workers' collection is admin-only.
    // This requires setting a custom claim 'admin: true' on the admin user's auth token,
    // which is typically done via a secure backend process (e.g., a Cloud Function).
    match /workers/{workerId} {
      allow read, write: if request.auth.token.admin == true;
    }
  }
}

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // 1. users
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // 2. leads
    match /leads/{leadId} {
      allow read, write: if request.auth.uid == resource.data.userId;
    }

    // 3. targets
    match /targets/{targetId} {
      allow read, write: if request.auth.uid == resource.data.userId;
    }

    // 4. workers (ADMIN ONLY)
    match /workers/{workerId} {
      allow read, write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // 5. rawPosts (Service/Admin access only for writes)
    match /rawPosts/{postId} {
        allow read: if false; // No client-side reads
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // 6. actions (Subcollection)
    match /users/{userId}/actions/{actionId} {
        allow read, write: if request.auth.uid == userId;
    }

    // 7. subscriptions
    match /subscriptions/{userId} {
        allow read, write: if request.auth.uid == userId;
    }

    // 8. payments
    match /payments/{paymentId} {
        allow read, write: if request.auth.uid == resource.data.userId;
    }

    // 9. systemMetrics (ADMIN ONLY)
    match /systemMetrics/current {
        allow read: if request.auth != null; // Allow all authenticated users to read system metrics
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
  }
}
